<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒë‹´ì¼ì§€ ì‘ì„±</title>
  <style>
    body { font-family: 'Nanum Gothic', sans-serif; max-width: 700px; margin: 60px auto; padding: 20px; background:#f8f9fa; }
    h2 { text-align:center; margin-bottom:30px; }
    .box { background:#fff; padding:30px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,.1); }
    .field { margin-bottom:20px; }
    .label { font-weight:700; margin-bottom:6px; display:block; }
    .value { background:#f1f2f6; padding:10px; border-radius:6px; word-break:break-word; }
    textarea, input[type="datetime-local"] { width:100%; padding:10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
    textarea { height:150px; resize:vertical; }
    .help { color:#666; font-size:12px; margin-top:6px; }
    .btn { display:inline-block; margin-top:30px; padding:12px 24px; background:#7ed6df; color:#fff; border-radius:8px; text-decoration:none; border:none; cursor:pointer; font-size:16px; }
    .btn:hover { background:#22a6b3; }
    .btn-row { text-align:center; gap:8px; display:flex; justify-content:center; flex-wrap:wrap; }
    details { background:#f7fafc; border:1px solid #e5e7eb; border-radius:8px; padding:12px; }
    details > summary { cursor:pointer; font-weight:600; }
    .inline { display:inline-block; margin-left:8px; }
    /* ë™ê¸°í™” ë°°ì§€ */
    .sync-banner { display:none; margin:-40px auto 20px; max-width:700px; padding:10px 14px; border-radius:10px; background:#ecfeff; border:1px solid #a5f3fc; color:#0e7490; font-size:14px; }
    .sync-banner.on { display:block; }
  </style>
</head>
<body>
  <div id="syncBanner" class="sync-banner">ğŸ”„ Firestore ë™ê¸°í™” ëª¨ë“œì…ë‹ˆë‹¤. ì´ í˜ì´ì§€ì—ì„œ ì €ì¥í•œ ë‚´ìš©ì€ ì—¬ëŸ¬ íƒœë¸”ë¦¿ì— ìë™ ê³µìœ ë¼ìš”.</div>
  <h2>ğŸ“ ìƒë‹´ì¼ì§€ ì‘ì„±</h2>
  <div class="box">
    <div class="field">
      <span class="label">ì‹ ì²­ì</span>
      <div class="value" id="req_student">{{ request_data.grade }}í•™ë…„ {{ request_data.class_num }}ë°˜ {{ request_data.number }}ë²ˆ {{ request_data.name }}</div>
    </div>

    <div class="field">
      <span class="label">ìƒë‹´ ì˜ì—­</span>
      <div class="value" id="req_category">{{ request_data.category }}</div>
    </div>

    <div class="field">
      <span class="label">ì£¼ì œ</span>
      <div class="value" id="req_topic">{{ request_data.topic }}</div>
    </div>

    <div class="field">
      <span class="label">ì‹ ì²­ ë‚´ìš©</span>
      <div class="value" id="req_content">{{ request_data.content }}</div>
    </div>

    <!-- âœ… ë‹µë³€ ë‚ ì§œëŠ” í•­ìƒ í‘œì‹œ (í¸ì§‘ ì—¬ë¶€ì™€ ë¬´ê´€) -->
    <div class="field">
      <span class="label">ë‹µë³€ ë‚ ì§œ</span>
      <div class="value" id="answer_date">
        {{ (log.date if log else default_dt_input|replace('T',' ')) }}
      </div>
    </div>

    <form id="logForm" method="post">
      {# â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë‚ ì§œ/ì‹œê°„ ìˆ˜ì • ë¸”ë¡: í™˜ê²½(ë°±ì—”ë“œ) í† ê¸€ì—ë§Œ ë”°ë¦„ â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
      {% if show_dt_edit %}
      <div class="field">
        <details id="dt-edit" open>
          <summary>â± ë‚ ì§œ/ì‹œê°„ ìˆ˜ì •</summary>
          <div style="margin-top:10px">
            <label class="label" for="log_dt">ì²˜ë¦¬(ê¸°ë¡) ì‹œê°</label>
            <input id="log_dt" type="datetime-local" name="log_dt" value="{{ default_dt_input }}">
            <label class="inline">
              <input id="apply_dt" type="checkbox" name="apply_dt"> ì´ ë‚ ì§œ/ì‹œê°„ìœ¼ë¡œ ì €ì¥
            </label>
            <div class="help">ì²´í¬í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ì‹œê°(ë˜ëŠ” í˜„ì¬ ì‹œê°)ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
          </div>
        </details>
      </div>
      {% endif %}

      <div class="field">
        <span class="label">ìƒë‹´ ë‚´ìš©</span>
        <textarea id="memo" name="memo" placeholder="ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">{{ log.memo if log else '' }}</textarea>
      </div>

      <div class="btn-row">
        <button type="submit" class="btn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        <a href="/consult_list" class="btn">ğŸ“‚ ëª©ë¡ìœ¼ë¡œ</a>

        <!-- ë™ê¸°í™” ëª¨ë“œì—ì„œë§Œ ë³´ì—¬ì¤„ ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° -->
        <button type="button" id="btnExport" class="btn" style="display:none">â¬‡ï¸ ë‚´ë³´ë‚´ê¸°(JSON)</button>
        <label class="btn" id="btnImportLabel" style="display:none">
          â¬†ï¸ ë¶ˆëŸ¬ì˜¤ê¸°(JSON)
          <input id="fileImport" type="file" accept="application/json" style="display:none">
        </label>
      </div>
    </form>
  </div>

  <!-- ===== ë™ê¸°í™” ëª¨ë“œ(ì˜µì…˜): ?store=firestore ë¡œ ì§„ì… ì‹œ í™œì„± ===== -->
  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      const useFirestore = params.get('store') === 'firestore';
      if (!useFirestore) return; // ê¸°ë³¸ ëª¨ë“œ(Flask POST) â†’ ì•„ë¬´ ì˜í–¥ ì—†ìŒ

      // ë°°ì§€/ë²„íŠ¼ í‘œì‹œ
      document.getElementById('syncBanner').classList.add('on');
      document.getElementById('btnExport').style.display = '';
      document.getElementById('btnImportLabel').style.display = '';

      // Firebase SDK ë¡œë“œ
      const s1 = document.createElement('script'); s1.src = "https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js";
      const s2 = document.createElement('script'); s2.src = "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js";
      s2.onload = initFirestore;
      document.body.append(s1, s2);

      function initFirestore() {
        // â¬‡ï¸ Firebase ì„¤ì •ê°’ (ì½˜ì†” ê°’ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨)
        const firebaseConfig = {
          apiKey: "AIzaSyBddJ-lxmjhIfYe-YR77wZrKRm6V5DeyE",
          authDomain: "advice-e7ca2.firebaseapp.com",
          projectId: "advice-e7ca2",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.enablePersistence({ synchronizeTabs: true }).catch(()=>{});

        const COL = "counsel_records_v1";

        // export/import
        document.getElementById('btnExport').addEventListener('click', async () => {
          const snap = await db.collection(COL).orderBy("updatedAt","desc").get();
          const items = snap.docs.map(d=>d.data());
          const blob = new Blob([JSON.stringify({items}, null, 2)], {type:"application/json"});
          const url = URL.createObjectURL(blob);
          const a = Object.assign(document.createElement('a'), {href:url, download:`counsel-backup-${new Date().toISOString().slice(0,10)}.json`});
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          alert('ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
        });

        document.getElementById('fileImport').addEventListener('change', async (e) => {
          const file = e.target.files[0]; if (!file) return;
          const text = await file.text();
          const data = JSON.parse(text);
          if (!data?.items) return alert('ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
          for (const item of data.items) {
            const id = item.id || crypto.randomUUID();
            await db.collection(COL).doc(id).set({...item, id}, {merge:true});
          }
          alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
        });

        // ğŸ” í¼ ì œì¶œì„ ê°€ë¡œì±„ Firestoreì— "ê³ ì • id"ë¡œ ì €ì¥í•œ ë’¤, ì„œë²„ì—ë„ ê·¸ëŒ€ë¡œ ì œì¶œ
        const form = document.getElementById('logForm');
        form.addEventListener('submit', async (ev) => {
          ev.preventDefault();

          try {
            // 0) ì„œë²„ ìš”ì²­ id â†’ /write_log/<id> ì—ì„œ ì¶”ì¶œ (ì—†ìœ¼ë©´ null)
            const reqId = (location.pathname.match(/\/write_log\/(\d+)/) || [])[1] || null;
            // Firestore ë¬¸ì„œ ê³ ì • id: ê°™ì€ ê±´ì€ í•­ìƒ ê°™ì€ ë¬¸ì„œë¡œ ë®ì–´ì“°ê¸°
            const docId = reqId ? `req_${reqId}` : (self.crypto?.randomUUID?.() ?? String(Date.now()));

            // 1) í…œí”Œë¦¿ì—ì„œ ë³´ì´ëŠ” ê°’ ì½ê¸°
            const sInfo = document.getElementById('req_student').innerText.trim(); // "3í•™ë…„ 2ë°˜ 10ë²ˆ í™ê¸¸ë™"
            const category = document.getElementById('req_category').innerText.trim();
            const topic = document.getElementById('req_topic').innerText.trim();
            const reqContent = document.getElementById('req_content').innerText.trim();
            const memo = document.getElementById('memo').value.trim();

            // 2) í•™ìƒ ì •ë³´ íŒŒì‹±(ë°œí‘œ/ìš´ì˜ì— ì¶©ë¶„)
            const m = sInfo.match(/(\d+)í•™ë…„\s+(\d+)ë°˜\s+(\d+)ë²ˆ\s+(.+)/);
            const [ , grade, class_num, number, name ] = m || [null,'','','',sInfo];

            // 3) ë‚ ì§œ ê²°ì •
            const nowIso = new Date().toISOString();
            const dtInputEl = document.getElementById('log_dt');
            const apply = document.getElementById('apply_dt')?.checked;
            const dateISO = (apply && dtInputEl?.value) ? new Date(dtInputEl.value).toISOString() : nowIso;

            // 4) ì €ì¥ payload
            const data = {
              id: docId,
              requestId: reqId,            // ì„œë²„ ìš”ì²­ idì™€ ì—°ê²°
              grade, class_num, number, name,
              category, topic,
              requestContent: reqContent,
              memo,
              dateISO,
              updatedAt: nowIso
            };

            // 5) Firestore upsert (ë™ì¼ ë¬¸ì„œ ë®ì–´ì“°ê¸°)
            await db.collection(COL).doc(docId).set(data, { merge: true });

          } catch (e) {
            console.warn('Firestore ì €ì¥ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜:', e);
            // Firestoreê°€ ì‹¤íŒ¨í•´ë„ ì„œë²„ ì €ì¥ì€ ê³„ì† ì§„í–‰
          } finally {
            // âœ… ì„œë²„ì—ë„ ê·¸ëŒ€ë¡œ ì €ì¥(ì›ë˜ ë™ì‘ ìœ ì§€)
            form.submit();
          }
        });
      }
    })();
  </script>
</body>
</html>
