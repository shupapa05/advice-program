<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìƒë‹´ ì‹ ì²­ ë‚´ì—­</title>
  <style>
    body{font-family:'Nanum Gothic',sans-serif;max-width:1000px;margin:60px auto;padding:20px;background:#f8f9fa}
    h2{text-align:center;margin-bottom:18px}
    .msg{text-align:center;margin:10px 0 22px;color:#0b7285;font-weight:600}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:10px;border:1px solid #ddd;text-align:center;vertical-align:middle}
    th{background:#7ed6df;color:#fff}
    tr:nth-child(even){background:#f2f2f2}
    .btn{padding:6px 14px;background:#22a6b3;color:#fff;border:none;border-radius:6px;text-decoration:none;display:inline-block}
    .btn:hover{background:#1e90a1}
    .date-form{display:flex;gap:6px;align-items:center;justify-content:center}
    .date-input{width:150px;padding:6px 8px;border:1px solid #ccc;border-radius:6px;font:inherit}
    .date-submit{padding:6px 10px;border:none;border-radius:6px;background:#6c5ce7;color:#fff;cursor:pointer}
    .date-submit:hover{background:#5a4bd6}
    .status-dot{display:inline-block;width:12px;height:12px;border-radius:999px;vertical-align:middle}
    .status-pending{background:#f5a524} /* ë…¸ë‘: ë¯¸ì‘ì„± */
    .status-done{background:#10b981}    /* ì´ˆë¡: ì‘ì„±ë¨ */
    .content-cell{ text-align:left }
  </style>
</head>
<body>
  <h2>ğŸ“‚ ìƒë‹´ ì‹ ì²­ ë‚´ì—­</h2>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="msg">
        {% for m in messages %}{{ m }}{% if not loop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ì„œë²„ì—ì„œ ë‚´ë ¤ì£¼ëŠ” ìŠ¤ì½”í”„(ë‹´ì„ìš© ë°˜ í•„í„°). ìƒë‹´/ê´€ë¦¬ìëŠ” ë¹ˆ ê°’ -->
  <div id="scope"
       data-grade="{{ filter_grade if filter_grade is not none else '' }}"
       data-class="{{ filter_class if filter_class is not none else '' }}"></div>

  <table id="reqTable">
    <thead>
      <tr>
        <!-- â‘  ì‹ ì²­ì¼(ì„œë²„ DB) -->
        <th>{{ 'ì‹ ì²­ì¼(ìˆ˜ì •)' if edit_date_enabled else 'ì‹ ì²­ì¼' }}</th>
        <th>í•™ë…„</th><th>ë°˜</th><th>ë²ˆí˜¸</th><th>ì´ë¦„</th>
        <th>ì£¼ì œ</th>
        <th>ë‚´ìš©</th>
        <!-- â‘¡ ìƒíƒœë§Œ(ìƒ‰ ì ) -->
        <th>ìƒíƒœ</th>
        <th>ì‘ì„±</th>
      </tr>
    </thead>
    <tbody id="reqTbody">
      {% for r in requests %}
      <tr>
        <td>
          {% if edit_date_enabled %}
          <!-- ì‹ ì²­ì¼ ìˆ˜ì •: ì„œë²„ DBë§Œ ì—…ë°ì´íŠ¸ -->
          <form class="date-form" action="/teacher/update_date" method="post">
            <input type="hidden" name="id" value="{{ r.id }}" />
            <input class="date-input" type="datetime-local" name="date" value="{{ r.date|replace(' ', 'T') }}" step="60" required />
            <button class="date-submit" type="submit">ìˆ˜ì •</button>
          </form>
          {% else %}
            {{ r.date }}
          {% endif %}
        </td>
        <td>{{ r.grade }}</td>
        <td>{{ r.class_num }}</td>
        <td>{{ r.number }}</td>
        <td>{{ r.name }}</td>
        <td>{{ r.topic }}</td>
        <td class="content-cell">{{ r.content }}</td>
        <!-- ìƒíƒœ/ë²„íŠ¼ì€ JSê°€ í™•ì • -->
        <td></td>
        <td><a class="btn" href="/write_log/{{ r.id }}">ì‘ì„±</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="text-align:center;margin-top:24px">
    <a href="/teacher_home" class="btn">ğŸ  êµì‚¬ í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

 <script>
  (function () {
    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBddJ-lxmjhIfYe-YR77wZrKRm6V5DeyE",
      authDomain: "advice-e7ca2.firebaseapp.com",
      projectId: "advice-e7ca2",
    };
    if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
    const db  = firebase.firestore();
    const COL = "counsel_records_v1";

    const table = document.getElementById('reqTable');
    const tbody = document.getElementById('reqTbody') || table.querySelector('tbody');

    // --- ë‹´ì„ ìŠ¤ì½”í”„(ìˆìœ¼ë©´ ê·¸ ë°˜ë§Œ) ---
    const SCOPE = document.getElementById('scope');
    const FILTER_GRADE = SCOPE?.dataset.grade || null;
    const FILTER_CLASS = SCOPE?.dataset.class || null;

    // ê°’ ì •ê·œí™”/ë¹„êµ(ìˆ«ì/ë¬¸ì ëª¨ë‘ ëŒ€ì‘)
    const norm = v => String(v ?? "").trim().replace(/\s+/g,"");
    const same = (a,b) => {
      const na = parseInt(a,10), nb = parseInt(b,10);
      if (!Number.isNaN(na) && !Number.isNaN(nb)) return na===nb;
      return norm(a)===norm(b);
    };
    const passScope = (g, c) => {
      if (!FILTER_GRADE || !FILTER_CLASS) return true;  // ìƒë‹´/ê´€ë¦¬ìëŠ” ì „ì²´
      return same(g, FILTER_GRADE) && same(c, FILTER_CLASS);
    };

    // ë‚ ì§œ íŒŒì‹±
    function parseDateToMs(txt){
      if(!txt) return 0;
      const t = (txt.includes(' ') && !txt.includes('T')) ? txt.replace(' ','T') : txt;
      const d = new Date(t); if(!isNaN(d)) return d.getTime();
      const m = txt.match(/(\d{4})[^\d]?(\d{1,2})[^\d]?(\d{1,2}).*?(\d{1,2})?:?(\d{1,2})?/);
      if(m){ const [_,Y,M,D,h='0',n='0']=m;
        return new Date(`${Y.padStart(4,'0')}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}T${String(h).padStart(2,'0')}:${String(n).padStart(2,'0')}:00`).getTime();
      }
      return 0;
    }
    function sortOnlyServer(){
      const rows=[...tbody.querySelectorAll('tr')].map(tr=>{
        const td=tr.querySelector('td'); const inp=td?.querySelector('input[type=datetime-local]');
        const txt=inp?.value || td?.innerText.trim() || '';
        return {tr,time:parseDateToMs(txt)};
      });
      rows.sort((a,b)=>b.time-a.time); tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r.tr));
    }

    async function loadAndMerge() {
      try {
        // (A) ì„œë²„ í…Œì´ë¸”ì—ì„œ ìŠ¤ì½”í”„ ë°– í–‰ ì œê±°(í˜¹ì‹œ ì„ì—¬ ì™”ì„ ë•Œ ëŒ€ë¹„)
        if (FILTER_GRADE && FILTER_CLASS) {
          [...tbody.querySelectorAll('tr')].forEach(tr=>{
            const tds = tr.querySelectorAll('td');
            const g = (tds[1]?.innerText||'').trim();
            const c = (tds[2]?.innerText||'').trim();
            if (!passScope(g, c)) tr.remove();
          });
        }

        // (B) ì„œë²„í–‰ ì¸ë±ì‹± + ì •ë ¬ìš© ë°°ì—´
        const rowByRid = new Map();
        const rows = [];
        const serverRows = Array.from(tbody.querySelectorAll('tr'));
        serverRows.forEach(tr=>{
          let rid = tr.querySelector('input[name="id"]')?.value || null;
          if (!rid) {
            const href = tr.querySelector('a.btn')?.getAttribute('href');
            const m = href?.match(/\/write_log\/(\d+)/); if (m) rid = m[1];
          }
          if (rid) rowByRid.set(String(rid), tr);

          const firstTd = tr.querySelector('td');
          const inp = firstTd?.querySelector('input[type=datetime-local]');
          const txt = inp?.value || firstTd?.innerText.trim() || '';
          tr.dataset.time = String(parseDateToMs(txt));
          rows.push({tr, time:+tr.dataset.time});
        });

        // (C) Firestore ì¿¼ë¦¬ë„ ìŠ¤ì½”í”„ í•„í„° ì ìš© (íƒ€ì… ë¶ˆì¼ì¹˜ ëŒ€ë¹„)
        let q = db.collection(COL);
        if (FILTER_GRADE && FILTER_CLASS) {
          const gNum = parseInt(FILTER_GRADE,10);
          const cNum = parseInt(FILTER_CLASS,10);
          const gVal = Number.isNaN(gNum) ? FILTER_GRADE : gNum;
          const cVal = Number.isNaN(cNum) ? FILTER_CLASS : cNum;
          q = q.where('grade','==', gVal).where('class_num','==', cVal);
        }
        q = q.orderBy('dateISO','desc');

        const answered = new Set();
        const snap = await q.get();

        // (D) ë³‘í•©
        snap.forEach(doc=>{
          const r = doc.data();
          // í˜¹ì‹œ íƒ€ì… ë¶ˆì¼ì¹˜ë¡œ whereê°€ ëª» ê±¸ë ¸ì„ ìƒí™© ëŒ€ë¹„, í•œ ë²ˆ ë” ì²´í¬
          if (!passScope(r.grade, r.class_num)) return;

          const rid = r.requestId || (doc.id?.startsWith('req_') ? doc.id.slice(4) : null);
          const d   = new Date(r.dateISO || r.updatedAt || Date.now());
          if (rid) answered.add(String(rid));

          let tr = rid ? rowByRid.get(String(rid)) : null;
          if (!tr) {
            const href = rid ? `/write_log/${rid}` : '#';
            tr = document.createElement('tr');
            tr.innerHTML = `
              <td></td>
              <td>${r.grade??''}</td>
              <td>${r.class_num??''}</td>
              <td>${r.number??''}</td>
              <td>${r.name??''}</td>
              <td>${r.topic??''}</td>
              <td style="text-align:left">${(r.memo??'').replace(/</g,"&lt;")}</td>
              <td><span class="status-dot status-done" title="ì‘ì„±ë¨"></span></td>
              <td>${href==='#'
                    ? '<span class="btn" style="opacity:.6;pointer-events:none">ì‘ì„±(ì—°ê²°ì—†ìŒ)</span>'
                    : `<a class="btn" href="${href}">ìˆ˜ì •</a>`}</td>`;
            tbody.appendChild(tr);
            rows.push({tr, time:d.getTime()||0});
          } else {
            const tds = tr.querySelectorAll('td');
            tds[7].innerHTML = `<span class="status-dot status-done" title="ì‘ì„±ë¨"></span>`;
            tds[8].innerHTML = `<a class="btn" href="/write_log/${rid}">ìˆ˜ì •</a>`;
            tr.dataset.time = String(d.getTime()||0); // ì‘ì„±ì¼ ê¸°ì¤€ ì •ë ¬
          }
        });

        // (E) ë¯¸ì‘ì„± í–‰(= Firestore ë¬¸ì„œ ì—†ìŒ)
        serverRows.forEach(tr=>{
          let rid = tr.querySelector('input[name="id"]')?.value || null;
          if (!rid) {
            const href = tr.querySelector('a.btn')?.getAttribute('href');
            const m = href?.match(/\/write_log\/(\d+)/); if (m) rid = m[1];
          }
          if (!rid || answered.has(String(rid))) return;
          const tds = tr.querySelectorAll('td');
          tds[7].innerHTML = `<span class="status-dot status-pending" title="ë¯¸ì‘ì„±"></span>`;
          tds[8].innerHTML = `<a class="btn" href="/write_log/${rid}">ì‘ì„±</a>`;
        });

        // (F) ìµœì‹ ìˆœ ì •ë ¬
        rows.forEach(r=>{ if(!r.time && r.tr?.dataset?.time) r.time = +r.tr.dataset.time; });
        rows.sort((a,b)=>b.time-a.time);
        tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r.tr));

        // (G) ì‹ ì²­ì¼(ì„œë²„) í¼ ì œì¶œ ì‹œ í¬ë§· ë³´ì •(Tâ†’ê³µë°±)
        document.querySelectorAll('.date-form').forEach(f=>{
          f.addEventListener('submit', ()=>{
            const inp=f.querySelector('input[name="date"]');
            if (inp && inp.value.includes('T')) inp.value = inp.value.replace('T',' ');
          });
        });
      } catch (e) {
        console.warn('Firestore í†µí•© ì‹¤íŒ¨ â†’ ì„œë²„ ë°ì´í„°ë§Œ ì •ë ¬:', e);
        sortOnlyServer();
      }
    })();
</script>

</body>
</html>

