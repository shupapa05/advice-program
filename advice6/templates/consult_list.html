<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìƒë‹´ ì‹ ì²­ ë‚´ì—­</title>
  <style>
    body{font-family:'Nanum Gothic',sans-serif;max-width:1000px;margin:60px auto;padding:20px;background:#f8f9fa}
    h2{text-align:center;margin-bottom:18px}
    .msg{text-align:center;margin:10px 0 22px;color:#0b7285;font-weight:600}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:10px;border:1px solid #ddd;text-align:center;vertical-align:middle}
    th{background:#7ed6df;color:#fff}
    tr:nth-child(even){background:#f2f2f2}
    .btn{padding:6px 14px;background:#22a6b3;color:#fff;border:none;border-radius:6px;text-decoration:none;display:inline-block}
    .btn:hover{background:#1e90a1}
    .date-form{display:flex;gap:6px;align-items:center;justify-content:center}
    .date-input{width:150px;padding:6px 8px;border:1px solid #ccc;border-radius:6px;font:inherit}
    .date-submit{padding:6px 10px;border:none;border-radius:6px;background:#6c5ce7;color:#fff;cursor:pointer}
    .date-submit:hover{background:#5a4bd6}
    .status-dot{display:inline-block;width:12px;height:12px;border-radius:999px;vertical-align:middle}
    .status-pending{background:#f5a524} /* ë…¸ë‘ */
    .status-done{background:#10b981}    /* ì´ˆë¡ */
    .fs-meta{margin-top:6px;font-size:12px;color:#4b5563}
    .mini-input{width:160px;padding:4px 6px;border:1px solid #ccc;border-radius:6px;font:inherit}
    .mini-btn{padding:4px 8px;border:none;border-radius:6px;background:#0ea5e9;color:#fff;cursor:pointer;font-size:12px}
    .mini-btn:hover{background:#0284c7}
    .content-cell{ text-align:left }
    .student-edit{ font-size:12px; margin-left:6px; }
  </style>
</head>
<body>
  <h2>ğŸ“‚ ìƒë‹´ ì‹ ì²­ ë‚´ì—­</h2>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="msg">
        {% for m in messages %}{{ m }}{% if not loop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- í‘œì‹œ/ìˆ˜ì • í† ê¸€ (ì—†ìœ¼ë©´ ê¸°ë³¸ 1) -->
  <div id="flags"
       data-fs-edit="{{ 1 if fs_date_edit_enabled|default(1) else 0 }}"
       data-student-edit="{{ 1 if student_edit_enabled|default(0) else 0 }}">
  </div>

  <table id="reqTable">
    <thead>
      <tr>
        <!-- â‘  ì‹ ì²­ì¼(ì„œë²„ DB) -->
        <th>{{ 'ì‹ ì²­ì¼(ìˆ˜ì •)' if edit_date_enabled else 'ì‹ ì²­ì¼' }}</th>
        <th>í•™ë…„</th><th>ë°˜</th><th>ë²ˆí˜¸</th><th>ì´ë¦„</th>
        <th>ì£¼ì œ</th>
        <th>ë‚´ìš©</th>
        <!-- â‘¡ ìƒíƒœ/ì‘ì„±ì¼(êµì‚¬, Firestore) -->
        <th>ìƒíƒœ / ì‘ì„±ì¼(êµì‚¬)</th>
        <th>ì‘ì„±</th>
      </tr>
    </thead>
    <tbody id="reqTbody">
      {% for r in requests %}
      <tr>
        <td>
          {% if edit_date_enabled %}
          <!-- ì‹ ì²­ì¼ ìˆ˜ì •: ì„œë²„ë§Œ ì—…ë°ì´íŠ¸ -->
          <form class="date-form" action="/teacher/update_date" method="post">
            <input type="hidden" name="id" value="{{ r.id }}" />
            <input class="date-input" type="datetime-local" name="date" value="{{ r.date|replace(' ', 'T') }}" step="60" required />
            <button class="date-submit" type="submit">ìˆ˜ì •</button>
          </form>
          {% else %}
            {{ r.date }}
          {% endif %}
        </td>
        <td>{{ r.grade }}</td>
        <td>{{ r.class_num }}</td>
        <td>{{ r.number }}</td>
        <td>{{ r.name }}</td>
        <td>{{ r.topic }}</td>
        <td class="content-cell">
          {{ r.content }}
          {% if student_edit_enabled|default(0) %}
            <a class="student-edit" href="/student_request_edit/{{ r.id }}">(ì‹ ì²­ë‚´ìš© ìˆ˜ì •)</a>
          {% endif %}
        </td>
        <!-- ìƒíƒœ/ì‘ì„±ì¼ì€ JSê°€ ì±„ì›ë‹ˆë‹¤ -->
        <td></td>
        <td><a class="btn" href="/write_log/{{ r.id }}">ì‘ì„±</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="text-align:center;margin-top:24px">
    <a href="/teacher_home" class="btn">ğŸ  êµì‚¬ í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    (function () {
      const firebaseConfig = {
        apiKey: "AIzaSyBddJ-lxmjhIfYe-YR77wZrKRm6V5DeyE",
        authDomain: "advice-e7ca2.firebaseapp.com",
        projectId: "advice-e7ca2",
      };
      if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const COL = "counsel_records_v1";

      const table = document.getElementById('reqTable');
      const tbody = document.getElementById('reqTbody') || table.querySelector('tbody');

      const FLAGS = document.getElementById('flags');
      const ALLOW_FS_EDIT = (FLAGS?.dataset.fsEdit ?? '1') === '1';

      // ìœ í‹¸
      function parseDateToMs(txt){
        if(!txt) return 0;
        const t = (txt.includes(' ') && !txt.includes('T')) ? txt.replace(' ','T') : txt;
        const d = new Date(t); if(!isNaN(d)) return d.getTime();
        const m = txt.match(/(\d{4})[^\d]?(\d{1,2})[^\d]?(\d{1,2}).*?(\d{1,2})?:?(\d{1,2})?/);
        if(m){ const [_,Y,M,D,h='0',n='0']=m;
          return new Date(`${Y.padStart(4,'0')}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}T${String(h).padStart(2,'0')}:${String(n).padStart(2,'0')}:00`).getTime();
        }
        return 0;
      }
      const pad = n => String(n).padStart(2,'0');
      const toLocalInputValue = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

      function sortOnlyServer(){
        const rows=[...tbody.querySelectorAll('tr')].map(tr=>{
          const td=tr.querySelector('td'); const inp=td?.querySelector('input[type=datetime-local]');
          const txt=inp?.value || td?.innerText.trim() || '';
          return {tr,time:parseDateToMs(txt)};
        });
        rows.sort((a,b)=>b.time-a.time); tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r.tr));
      }

      async function loadAndMerge() {
        try {
          // 1) ì„œë²„í–‰ ì¸ë±ìŠ¤(ì‹ ì²­ID â†’ tr)
          const rowByRid = new Map();
          const serverRows = Array.from(tbody.querySelectorAll('tr'));
          serverRows.forEach(tr=>{
            let rid = tr.querySelector('input[name="id"]')?.value || null;
            if (!rid) {
              const href = tr.querySelector('a.btn')?.getAttribute('href');
              const m = href?.match(/\/write_log\/(\d+)/);
              if (m) rid = m[1];
            }
            if (rid) rowByRid.set(String(rid), tr);
          });

          // ì •ë ¬ìš© ë°°ì—´(ì´ˆê¸°ì—” ì„œë²„í–‰/ì‹ ì²­ì¼ë¡œ)
          const rows = [];
          serverRows.forEach(tr=>{
            const td=tr.querySelector('td'); const inp=td?.querySelector('input[type=datetime-local]');
            const txt=inp?.value || td?.innerText.trim() || '';
            tr.dataset.time = String(parseDateToMs(txt));
            rows.push({tr, time:+tr.dataset.time});
          });

          // 2) Firestore ë¬¸ì„œ ë¡œë“œ â†’ ì„œë²„í–‰ì„ ë®ì–´ì¨ ìƒíƒœ/ë²„íŠ¼/ì‘ì„±ì¼ì„ í™•ì •
          const answered = new Set();
          const snap = await db.collection(COL).orderBy("dateISO","desc").get();
          snap.forEach(doc=>{
            const r = doc.data();
            const rid = r.requestId || (doc.id?.startsWith('req_') ? doc.id.slice(4) : null);
            const d = new Date(r.dateISO || r.updatedAt || Date.now());
            const localLabel = isNaN(d) ? (r.dateISO || r.updatedAt || '') : d.toLocaleString('ko-KR');
            const localInput = isNaN(d) ? '' : toLocalInputValue(d);
            if (rid) answered.add(String(rid));

            let tr = rid ? rowByRid.get(String(rid)) : null;
            if (!tr) {
              // ì„œë²„ì— ì—†ëŠ” ê±´ì€ ìƒˆ í–‰ ì¶”ê°€ (ì‹ ì²­ì¼ ê³µë€)
              tr = document.createElement('tr');
              tr.innerHTML = `
                <td></td>
                <td>${r.grade??''}</td>
                <td>${r.class_num??''}</td>
                <td>${r.number??''}</td>
                <td>${r.name??''}</td>
                <td>${r.topic??''}</td>
                <td class="content-cell">${(r.memo??'').replace(/</g,"&lt;")}</td>
                <td></td>
                <td>${rid?`<a class="btn" href="/write_log/${rid}">ìˆ˜ì •</a>`:'<span class="btn" style="opacity:.6;pointer-events:none">ì‘ì„±(ì—°ê²°ì—†ìŒ)</span>'}</td>`;
              tbody.appendChild(tr);
              rows.push({tr, time: d.getTime()||0});
            }

            // ìƒíƒœ/ì‘ì„±ì¼(êµì‚¬) ì…€ êµ¬ì„± + ë²„íŠ¼ 'ìˆ˜ì •' í™•ì •
            const tds = tr.querySelectorAll('td');
            const statusCell = tds[7];
            statusCell.innerHTML = `
              <div><span class="status-dot status-done" title="ì‘ì„±ë¨"></span></div>
              <div class="fs-meta">
                ì‘ì„±ì¼: <span class="fs-date">${localLabel}</span>
                ${ALLOW_FS_EDIT && rid ? `
                  <form class="fs-date-form" data-rid="${rid}" style="display:inline-block;margin-left:6px">
                    <input class="mini-input" type="datetime-local" name="fs_date" value="${localInput}" step="60" required>
                    <button class="mini-btn" type="submit">ì €ì¥</button>
                  </form>` : ''}
              </div>
            `;
            tds[8].innerHTML = `<a class="btn" href="/write_log/${rid}">ìˆ˜ì •</a>`;

            // ì •ë ¬ ê¸°ì¤€ì„ ì‘ì„±ì¼(êµì‚¬)ë¡œ ê°±ì‹ 
            tr.dataset.time = String(d.getTime()||0);
          });

          // 3) Firestoreì— ì—†ëŠ” ì„œë²„í–‰ì€ 'ë¯¸ì‘ì„±(ë…¸ë‘) + [ì‘ì„±]'ìœ¼ë¡œ í™•ì •
          serverRows.forEach(tr=>{
            let rid = tr.querySelector('input[name="id"]')?.value || null;
            if (!rid) {
              const href = tr.querySelector('a.btn')?.getAttribute('href');
              const m = href?.match(/\/write_log\/(\d+)/); if (m) rid = m[1];
            }
            if (!rid || answered.has(String(rid))) return;
            const tds = tr.querySelectorAll('td');
            tds[7].innerHTML = `
              <div><span class="status-dot status-pending" title="ë¯¸ì‘ì„±"></span></div>
              <div class="fs-meta">ì‘ì„±ì¼: -</div>
            `;
            tds[8].innerHTML = `<a class="btn" href="/write_log/${rid}">ì‘ì„±</a>`;
          });

          // 4) ìµœì‹ ìˆœ ì •ë ¬(ì‘ì„±ì¼ ìˆìœ¼ë©´ ê·¸ê²ƒ, ì—†ìœ¼ë©´ ì‹ ì²­ì¼)
          rows.forEach(r=>{ if(!r.time && r.tr?.dataset?.time) r.time = +r.tr.dataset.time; });
          rows.sort((a,b)=>b.time-a.time);
          tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r.tr));

          // 5) í¼ ì´ë²¤íŠ¸ ì—°ê²°
          attachServerDateSubmitFix();     // ì‹ ì²­ì¼(ì„œë²„) í¼ í¬ë§· ë³´ì •
          if (ALLOW_FS_EDIT) attachFirestoreDateEditor(db); // ì‘ì„±ì¼(êµì‚¬) ì €ì¥
        } catch (e) {
          console.warn('Firestore í†µí•© ì‹¤íŒ¨ â†’ ì„œë²„ ë°ì´í„°ë§Œ ì •ë ¬:', e);
          sortOnlyServer();
        }
      }

      // ì‹ ì²­ì¼(ì„œë²„) í¼: ì„œë²„ê°€ "YYYY-MM-DD HH:MM"ì„ ê¸°ëŒ€í•˜ë©´ Tâ†’ê³µë°±ìœ¼ë¡œ ë³´ì •
      function attachServerDateSubmitFix(){
        const forms = document.querySelectorAll('.date-form');
        forms.forEach(form=>{
          form.addEventListener('submit', (e)=>{
            const inp = form.querySelector('input[name="date"]');
            if (inp && inp.value.includes('T')) {
              inp.value = inp.value.replace('T',' ');
            }
          });
        });
      }

      // ì‘ì„±ì¼(êµì‚¬) ì €ì¥ â†’ Firestoreë§Œ ì—…ë°ì´íŠ¸(ì„œë²„ ì‹ ì²­ì¼ì—” ì˜í–¥ ì—†ìŒ)
      function attachFirestoreDateEditor(db){
        document.querySelectorAll('.fs-date-form').forEach(f=>{
          f.addEventListener('submit', async (e)=>{
            e.preventDefault();
            const rid = f.dataset.rid;
            const val = f.querySelector('input[name="fs_date"]').value; // "YYYY-MM-DDTHH:MM"
            if (!rid || !val) return;
            try{
              await db.collection(COL).doc('req_'+rid).set({
                dateISO: new Date(val).toISOString(),
                updatedAt: new Date().toISOString()
              }, { merge:true });
              // ë¼ë²¨ ê°±ì‹ 
              const label = f.closest('.fs-meta').querySelector('.fs-date');
              const d = new Date(val);
              label.textContent = isNaN(d) ? val : d.toLocaleString('ko-KR');
            }catch(err){
              alert('ì‘ì„±ì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              console.warn(err);
            }
          });
        });
      }

      loadAndMerge();
    })();
  </script>
</body>
</html>
