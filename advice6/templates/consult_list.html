<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>상담 신청 내역</title>
  <style>
    body{font-family:'Nanum Gothic',sans-serif;max-width:1100px;margin:60px auto;padding:20px;background:#f7f7fb}
    h2{text-align:center;margin-bottom:18px}
    .msg{text-align:center;margin:10px 0 22px;color:#0b7285;font-weight:600}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:10px;border:1px solid #ddd;text-align:center}
    th{background:#7ed6df;color:#fff}
    tr:nth-child(even){background:#f6fafe}
    .btn{padding:6px 14px;background:#22a6b3;color:#fff;border:none;border-radius:6px;text-decoration:none;display:inline-block}
    .btn:hover{background:#1e90a1}
    .date-form{display:flex;gap:6px;align-items:center;justify-content:center}
    .date-input{width:170px;padding:6px 8px;border:1px solid #ccc;border-radius:6px;font:inherit}
    .date-submit{padding:6px 10px;border:none;border-radius:6px;background:#6c5ce7;color:#fff;cursor:pointer}
    .date-submit:hover{background:#5a4bd6}
    .badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:12px;margin-right:6px}
    .badge-wait{background:#fff3cd;color:#9c6b00;border:1px solid #ffe08a}
    .badge-done{background:#e6fcf5;color:#0b7285;border:1px solid #96f2d7}
    .pagination{margin:18px 0;display:flex;gap:6px;justify-content:center}
    .page-btn{padding:6px 10px;border:1px solid #ccc;border-radius:6px;text-decoration:none;color:#333;background:#fff}
    .page-btn.on{background:#22a6b3;color:#fff;border-color:#22a6b3}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}

    /* 필터 폼 + 배지 영역 */
    .filters-form{display:flex;gap:8px;align-items:end;margin:6px 0 10px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:4px}
    .field input,.field select{padding:6px 8px;border:1px solid #ccc;border-radius:6px;font:inherit;min-width:160px}
    .filters{display:flex;justify-content:space-between;align-items:center;margin:10px 0 14px}
    .filters .left{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .filters .reset{background:#fff;border:1px solid #ccc;color:#333}
    .filters .reset:hover{background:#f1f3f5}
  </style>
</head>
<body>
  <div class="toolbar">
    <h2>📂 상담 신청 내역</h2>
    <a href="/teacher_home" class="btn">🏠 교사 홈</a>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="msg">
        {% for m in messages %}{{ m }}{% if not loop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# ===== 1) 간단 필터 폼 ===== #}
  <form method="get" class="filters-form">
    <div class="field">
      <label>번호</label>
      <input name="number" type="number" min="1" value="{{ request.args.get('number','') }}">
    </div>
    <div class="field">
      <label>주제</label>
      <input name="topic" type="text" placeholder="예: 학업" value="{{ request.args.get('topic','') }}">
    </div>
    <div class="field">
      <label>시작</label>
      <input name="from" type="datetime-local" value="{{ request.args.get('from','') }}">
    </div>
    <div class="field">
      <label>종료</label>
      <input name="to" type="datetime-local" value="{{ request.args.get('to','') }}">
    </div>
    <button class="btn" style="height:36px;margin-bottom:2px">적용</button>
    <a class="btn" style="background:#fff;border:1px solid #ccc;color:#333;height:36px;line-height:24px;margin-bottom:2px"
       href="{{ url_for('consult_list') }}">초기화</a>
  </form>

  {# ===== 2) 활성 필터 배지 + 초기화 버튼 ===== #}
  {% set q_number = request.args.get('number') %}
  {% set q_name   = request.args.get('name') %}
  {% set q_topic  = request.args.get('topic') %}
  {% set q_from   = request.args.get('from') %}
  {% set q_to     = request.args.get('to') %}
  {% set has_filters = q_number or q_name or q_topic or q_from or q_to %}
  <div class="filters">
    <div class="left">
      {% if has_filters %}
        <span style="font-weight:600;">적용된 필터:</span>
        {% if q_number %}<span class="badge" style="background:#e7f5ff;color:#1864ab;border:1px solid #a5d8ff;">번호 {{ q_number }}</span>{% endif %}
        {% if q_name   %}<span class="badge" style="background:#e7f5ff;color:#1864ab;border:1px solid #a5d8ff;">이름 {{ q_name }}</span>{% endif %}
        {% if q_topic  %}<span class="badge" style="background:#e6fcf5;color:#087f5b;border:1px solid #96f2d7;">주제 {{ q_topic }}</span>{% endif %}
        {% if q_from   %}<span class="badge" style="background:#f1f3f5;color:#495057;border:1px solid #dee2e6;">시작 {{ q_from }}</span>{% endif %}
        {% if q_to     %}<span class="badge" style="background:#f1f3f5;color:#495057;border:1px solid #dee2e6;">종료 {{ q_to }}</span>{% endif %}
      {% else %}
        <span class="badge" style="background:#f1f3f5;color:#495057;border:1px solid #dee2e6;">필터 없음 (담임 반 전체)</span>
      {% endif %}
    </div>
    <div>
      {% if has_filters %}
        <a class="btn reset" href="{{ url_for('consult_list') }}">필터 초기화</a>
      {% endif %}
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>{{ '신청일(수정)' if edit_date_enabled else '신청일' }}</th>
        <th>학년</th><th>반</th><th>번호</th><th>이름</th>
        <th>주제</th><th>내용</th><th>상태</th><th>작성</th>
      </tr>
    </thead>
    <tbody>
      {% for r in requests %}
      <tr>
        <td>
          {% if edit_date_enabled %}
          <form class="date-form" action="/teacher/update_date" method="post">
            <input type="hidden" name="id" value="{{ r.id }}" />
            <input type="hidden" name="page" value="{{ page }}" />
            <input class="date-input" type="datetime-local" name="date"
                   value="{{ r.date|replace(' ', 'T') }}" step="60" required />
            <button class="date-submit" type="submit">수정</button>
          </form>
          {% else %}
            {{ r.date }}
          {% endif %}
        </td>
        <td>{{ r.grade }}</td>
        <td>{{ r.class_num }}</td>
        <td>{{ r.number }}</td>
        <td>{{ r.name }}</td>
        <td>{{ r.topic }}</td>
        <td style="text-align:left">{{ r.content }}</td>
        <td>
          {% if r.has_log %}
            <span class="badge badge-done">✅ 완료</span>
          {% else %}
            <span class="badge badge-wait">🟡 대기</span>
          {% endif %}
        </td>
        <td>
          <a class="btn" href="{{ url_for('write_log', req_id=r.id, page=page) }}">{{ r.btn_label }}</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="pagination">
    {% for p in range(1, page_count + 1) %}
      {% if p == page %}
        <span class="page-btn on">{{ p }}</span>
      {% else %}
        <!-- 페이지 이동 시 현재 필터 유지 -->
        <a class="page-btn"
           href="{{ url_for('consult_list') }}?page={{ p }}{% if request.args.get('per_page') %}&per_page={{ request.args.get('per_page') }}{% endif %}{% if q_number %}&number={{ q_number }}{% endif %}{% if q_name %}&name={{ q_name|urlencode }}{% endif %}{% if q_topic %}&topic={{ q_topic|urlencode }}{% endif %}{% if q_from %}&from={{ q_from|urlencode }}{% endif %}{% if q_to %}&to={{ q_to|urlencode }}{% endif %}">
          {{ p }}
        </a>
      {% endif %}
    {% endfor %}
  </div>
</body>
</html>
