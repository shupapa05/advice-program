<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìƒë‹´ ì‹ ì²­ ë‚´ì—­</title>
  <style>
    body{font-family:'Nanum Gothic',sans-serif;max-width:1000px;margin:60px auto;padding:20px;background:#f8f9fa}
    h2{text-align:center;margin-bottom:18px}
    .msg{text-align:center;margin:10px 0 22px;color:#0b7285;font-weight:600}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:10px;border:1px solid #ddd;text-align:center}
    th{background:#7ed6df;color:#fff}
    tr:nth-child(even){background:#f2f2f2}
    .btn{padding:6px 14px;background:#22a6b3;color:#fff;border:none;border-radius:6px;text-decoration:none;display:inline-block}
    .btn:hover{background:#1e90a1}
    .date-form{display:flex;gap:6px;align-items:center;justify-content:center}
    .date-input{width:150px;padding:6px 8px;border:1px solid #ccc;border-radius:6px;font:inherit}
    .date-submit{padding:6px 10px;border:none;border-radius:6px;background:#6c5ce7;color:#fff;cursor:pointer}
    .date-submit:hover{background:#5a4bd6}
  </style>
</head>
<body>
  <h2>ğŸ“‚ ìƒë‹´ ì‹ ì²­ ë‚´ì—­</h2>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="msg">
        {% for m in messages %}{{ m }}{% if not loop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <table id="reqTable">
    <thead>
      <tr>
        <th>{{ 'ì‹ ì²­ì¼(ìˆ˜ì •)' if edit_date_enabled else 'ì‹ ì²­ì¼' }}</th>
        <th>í•™ë…„</th><th>ë°˜</th><th>ë²ˆí˜¸</th><th>ì´ë¦„</th>
        <th>ì£¼ì œ</th><th>ë‚´ìš©</th><th>ìƒíƒœ</th><th>ì‘ì„±</th>
      </tr>
    </thead>
    <tbody id="reqTbody">
      {% for r in requests %}
      <tr>
        <td>
          {% if edit_date_enabled %}
          <form class="date-form" action="/teacher/update_date" method="post">
            <input type="hidden" name="id" value="{{ r.id }}" />
            <input class="date-input" type="datetime-local" name="date" value="{{ r.date|replace(' ', 'T') }}" step="60" required />
            <button class="date-submit" type="submit">ìˆ˜ì •</button>
          </form>
          {% else %}
            {{ r.date }}
          {% endif %}
        </td>
        <td>{{ r.grade }}</td>
        <td>{{ r.class_num }}</td>
        <td>{{ r.number }}</td>
        <td>{{ r.name }}</td>
        <td>{{ r.topic }}</td>
        <td style="text-align:left">{{ r.content }}</td>
        <td>{{ r.checked }}</td>
        <td><a class="btn" href="/write_log/{{ r.id }}">ì‘ì„±</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="text-align:center;margin-top:24px">
    <a href="/teacher_home" class="btn">ğŸ  êµì‚¬ í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <!-- í•­ìƒ Firestoreë¥¼ ë¶ˆëŸ¬ì™€ì„œ ì„œë²„ ë°ì´í„°ì™€ í•©ì³ ìµœì‹ ìˆœ ì •ë ¬ -->
  <script>
    // Firebase SDK ë¡œë“œ (ì‹¤íŒ¨í•´ë„ í˜ì´ì§€ëŠ” ë™ì‘í•˜ë„ë¡)
    (function loadFirebase() {
      var a=document.createElement('script'); a.src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js";
      var b=document.createElement('script'); b.src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js";
      b.onload=init; document.body.append(a,b);
      b.onerror=sortOnlyServer; // Firestore ë¶ˆê°€ì‹œ ì„œë²„ ë°ì´í„°ë§Œ ì •ë ¬
    })();

    // ë¬¸ìì—´ ë‚ ì§œ â†’ ms
    function parseDateToMs(txt){
      if(!txt) return 0;
      var t = (txt.includes(' ') && !txt.includes('T')) ? txt.replace(' ','T') : txt;
      var d = new Date(t); if(!isNaN(d)) return d.getTime();
      var m = txt.match(/(\d{4}).?(\d{1,2}).?(\d{1,2}).*?(\d{1,2})?:?(\d{1,2})?/);
      if(m){var Y=m[1],M=m[2],D=m[3],h=m[4]||'0',n=m[5]||'0';
        return new Date(`${Y.padStart(4,'0')}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}T${String(h).padStart(2,'0')}:${String(n).padStart(2,'0')}:00`).getTime();
      }
      return 0;
    }

    function sortOnlyServer(){
      var tbody=document.getElementById('reqTbody'); if(!tbody) return;
      var rows=[...tbody.querySelectorAll('tr')].map(tr=>{
        var firstTd = tr.querySelector('td');
        var input = firstTd?.querySelector('input[type="datetime-local"]');
        var txt = input?.value || firstTd?.innerText.trim() || '';
        return {tr, time:parseDateToMs(txt)};
      });
      rows.sort((a,b)=>b.time-a.time); tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r.tr));
    }

    async function init(){
      try{
        const firebaseConfig = {
          apiKey: "AIzaSyBddJ-lxmjhIfYe-YR77wZrKRm6V5DeyE",
          authDomain: "advice-e7ca2.firebaseapp.com",
          projectId: "advice-e7ca2",
        };
        if(!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const COL = "counsel_records_v1";

        var table=document.getElementById('reqTable');
        var tbody=document.getElementById('reqTbody')||table.querySelector('tbody');

        // 0) ê¸°ì¡´ ì„œë²„ í–‰ë“¤ì˜ 'ì‘ì„±' ë§í¬ ìˆ˜ì§‘(ì¤‘ë³µ ë°©ì§€ìš©)
        const existingWriteLinks = new Set(
          [...tbody.querySelectorAll('a.btn')].map(a=>a.getAttribute('href')).filter(Boolean)
        );

        // 1) ì„œë²„ í–‰ ìˆ˜ì§‘(ë‚ ì§œ ìˆ˜ì • í¼ë„ ì§€ì›: input value ìš°ì„ )
        var rows=[...tbody.querySelectorAll('tr')].map(tr=>{
          var firstTd = tr.querySelector('td');
          var input = firstTd?.querySelector('input[type="datetime-local"]');
          var txt = input?.value || firstTd?.innerText.trim() || '';
          return { tr, time: parseDateToMs(txt) };
        });

        // 2) Firestore ë°ì´í„° (ìµœì‹ ìˆœ)
        const snap = await db.collection(COL).orderBy("dateISO","desc").get();
        snap.forEach(doc=>{
          const r=doc.data();
          const d=new Date(r.dateISO||r.updatedAt||Date.now());
          const dateStr = isNaN(d)?(r.dateISO||r.updatedAt||''): d.toLocaleString('ko-KR');

          // ë™ì¼ requestIdê°€ ì„œë²„ í‘œì— ì´ë¯¸ ìˆìœ¼ë©´ ì¤‘ë³µ ì¶”ê°€ ìŠ¤í‚µ
          const href = r.requestId ? `/write_log/${r.requestId}` : '#';
          if (r.requestId && existingWriteLinks.has(href)) return;

          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${dateStr}</td>
            <td>${r.grade??''}</td>
            <td>${r.class_num??''}</td>
            <td>${r.number??''}</td>
            <td>${r.name??''}</td>
            <td>${r.topic??''}</td>
            <td style="text-align:left">${(r.memo??'').replace(/</g,"&lt;")}</td>
            <td>ì™„ë£Œ</td>
            <td><a class="btn" href="${href}">ì‘ì„±</a></td>`;
          rows.push({ tr, time: d.getTime()||0 });
        });

        // 3) ì „ì²´ ìµœì‹ ìˆœ ì •ë ¬
        rows.sort((a,b)=>b.time-a.time);
        tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r.tr));

        // 4) ë‚ ì§œ ìˆ˜ì • â†’ Firestoreì—ë„ ë¯¸ëŸ¬(í•´ë‹¹ ë¬¸ì„œê°€ ìˆì„ ë•Œë§Œ)
        attachDateMirror(db, COL);
      }catch(e){
        console.warn('Firestore í†µí•© ì‹¤íŒ¨, ì„œë²„ ë°ì´í„°ë§Œ ì •ë ¬í•©ë‹ˆë‹¤:', e);
        sortOnlyServer();
      }
    }

    function attachDateMirror(db, COL){
      const forms = document.querySelectorAll('.date-form');
      forms.forEach(form => {
        form.addEventListener('submit', async (e) => {
          if (form.dataset.fsdone === '1') return; // ì¬ì§„ì… ë°©ì§€
          e.preventDefault();
          try {
            const id = form.querySelector('input[name="id"]')?.value;
            const dt = form.querySelector('input[name="date"]')?.value; // "YYYY-MM-DDTHH:MM"
            if (!id || !dt) { form.dataset.fsdone='1'; form.submit(); return; }
            const ref = db.collection(COL).doc('req_' + id);
            const snap = await ref.get();
            if (snap.exists) {
              await ref.set({
                dateISO: new Date(dt).toISOString(),
                updatedAt: new Date().toISOString()
              }, { merge: true });
            }
          } catch (err) {
            console.warn('Firestore date mirror ì‹¤íŒ¨(ì„œë²„ëŠ” ê³„ì† ì§„í–‰):', err);
          } finally {
            form.dataset.fsdone = '1';
            form.submit();
          }
        }, { capture: true });
      });
    }
  </script>
</body>
</html>
