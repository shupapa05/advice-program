<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>내 상담 내역</title>
  <style>
    body {
      font-family: 'Nanum Gothic', sans-serif;
      max-width: 980px;
      margin: 60px auto;
      padding: 20px;
      background-color: #f8f9fa;
    }
    h2 { text-align: center; margin-bottom: 18px; }
    .sub { text-align:center; color:#555; margin: -6px 0 18px; font-size:14px; }

    table { width: 100%; border-collapse: collapse; background-color: white; }
    th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #7ed6df; color: white; }
    tr:nth-child(even) { background-color: #f4f4f4; }
    td.txt-left { text-align: left; }

    .btn {
      display: inline-block; padding: 10px 18px; background-color: #7ed6df; color: white;
      border-radius: 8px; text-decoration: none; font-size: 14px; border: none; cursor: pointer;
    }
    .btn:hover { background-color: #22a6b3; }

    .btn-sm { padding: 6px 10px; font-size: 13px; border-radius: 6px; }
    .btn-danger { background:#ef4444; }
    .btn-danger:hover { background:#dc2626; }
    .btn-ghost { background:#fff; color:#111; border:1px solid #ccc; }
    .btn-ghost:hover { background:#f3f4f6; }

    .actions { display:flex; gap:6px; justify-content:center; align-items:center; flex-wrap:wrap; }
    .pwbar {
      display:flex; gap:8px; align-items:center; justify-content:center;
      margin: 0 0 12px; font-size:14px;
    }
    .pwbar input {
      padding:8px 10px; border:1px solid #ccc; border-radius:6px; width:200px; font:inherit;
    }

    .footer { text-align: center; margin-top: 24px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h2>🗂 {{ name }}님의 상담 신청 내역</h2>
  <div class="sub">※ 신청 내용은 직접 수정할 수 있고, 삭제 시에는 비밀번호가 필요합니다.</div>

  {% if data %}
    <!-- 공통 비밀번호 입력: 삭제 버튼 눌렀을 때 비어 있으면 여기 값이 자동 사용됩니다. -->
    <div class="pwbar">
      <span>🛡 삭제 비밀번호:</span>
      <input id="globalPw" type="password" placeholder="비밀번호 한 번만 입력">
      <button class="btn btn-ghost btn-sm" type="button" onclick="document.getElementById('globalPw').value=''">지우기</button>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:130px">신청일</th>
          <th style="width:110px">주제</th>
          <th>내용</th>
          <th style="width:90px">상태</th>
          <th style="width:90px">교사 답변</th>
          <th style="width:140px">내 신청 관리</th>
        </tr>
      </thead>
      <tbody>
        {% for item in data %}
        <tr>
          <td>{{ item.date }}</td>
          <td>{{ item.topic }}</td>
          <td class="txt-left">{{ item.content }}</td>
          <td>{{ item.status }}</td>
          <td>
            {% if item.answer %}
              <a class="btn btn-sm" href="/view_answer/{{ item.id }}" target="_blank">🔍 보기</a>
            {% else %}-{% endif %}
          </td>
          <td>
            <div class="actions">
              <!-- 수정: 편집 페이지로 이동(그 페이지에서 비밀번호 확인) -->
              <a class="btn btn-sm" href="/student_request_edit/{{ item.id }}">✏️ 수정</a>

              <!-- 삭제: 비밀번호 필요(빈 경우 위의 공통 입력값 자동 사용) -->
              <form class="del-form" action="/student_request_delete/{{ item.id }}" method="post"
                    onsubmit="return handleDeleteSubmit(this)">
                <input type="password" name="password" placeholder="비번" style="padding:6px 8px;border:1px solid #ccc;border-radius:6px;width:90px">
                <button type="submit" class="btn btn-danger btn-sm">🗑 삭제</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p style="text-align: center; margin-top: 40px;">조회된 상담 내역이 없습니다.</p>
  {% endif %}

  <div class="footer">
    <a class="btn" href="/check_request">🔙 상담 내역 다시 조회하기</a>
    <a class="btn" href="/">🏠 처음 화면으로</a>
  </div>

  <script>
    // 삭제 폼 제출 시: 행의 password가 비어 있으면 상단 공통 비밀번호를 사용
    function handleDeleteSubmit(form){
      const rowPw = form.querySelector('input[name="password"]');
      if(!rowPw.value){
        const global = document.getElementById('globalPw').value.trim();
        if(!global){
          alert('삭제하려면 비밀번호가 필요합니다.');
          return false;
        }
        rowPw.value = global; // 공통 비번 복사
      }
      return confirm('정말 삭제할까요? 삭제 후 복구할 수 없습니다.');
    }
  </script>
</body>
</html>
