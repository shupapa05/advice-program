<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í†µê³„ ëŒ€ì‹œë³´ë“œ</title>
  <style>
    :root{
      --bg:#f7fafc; --card:#ffffff; --ink:#1f2937; --sub:#475569;
      --blue:#7ed6df; --blue-dark:#22a6b3; --violet:#6c5ce7;
      --green:#10b981; --yellow:#f59e0b; --border:#e5e7eb;
      --shadow:0 8px 20px rgba(0,0,0,.06); --radius:16px;
    }
    *{box-sizing:border-box}
    body{font-family:'Nanum Gothic',sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:40px 20px 60px;line-height:1.6;font-size:17px}
    .wrap{max-width:1100px;margin:0 auto}
    .hero{background:linear-gradient(135deg, var(--blue) 0%, var(--violet) 100%);color:#fff;padding:28px 26px;border-radius:20px;box-shadow:var(--shadow);margin-bottom:26px}
    .hero h1{margin:0 0 10px;font-size:32px}
    .hero p{margin:0;opacity:.95;font-size:18px}

    .grid{display:grid;gap:16px}
    .grid.metrics{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .metric .label{color:var(--sub);font-size:14px;margin-bottom:6px}
    .metric .value{font-size:28px;font-weight:800}
    .muted{color:var(--sub);font-size:14px}

    .bar{width:100%;height:10px;background:#edf2f7;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar>span{display:block;height:100%;background:var(--green)}

    .section{margin-top:26px}
    .section h2{font-size:22px;margin:0 0 12px 2px}

    .list{display:grid;gap:10px}
    .row{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .row .tag{font-size:13px;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#4f46e5;border:1px solid #e5e7eb}
    .row strong{font-size:18px}
    .pill{padding:4px 10px;border-radius:999px;background:#ecfeff;color:#0e7490;font-size:13px;border:1px solid #a5f3fc}

    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden}
    th,td{padding:12px 10px;border-bottom:1px solid var(--border);text-align:center}
    th{background:#f1f5f9;font-weight:700}
    tr:last-child td{border-bottom:none}
    .left{text-align:left}

    .two-col{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media (max-width:960px){.two-col{grid-template-columns:1fr}}

    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
    .btn{display:inline-block;padding:10px 16px;border-radius:10px;text-decoration:none;background:var(--blue);color:#fff;border:1px solid var(--blue-dark)}
    .btn:hover{background:var(--blue-dark)}

    /* ì°¨íŠ¸ ìº”ë²„ìŠ¤ í‚¤ìš°ê¸° */
    .chart-box{padding:14px}
    .chart-box canvas{width:100%;max-height:320px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>ğŸ“Š ìƒë‹´ í†µê³„</h1>
      <p>ìµœê·¼ í˜„í™©ì„ í•œ ëˆˆì— í™•ì¸í•˜ì„¸ìš”.</p>
    </div>

    <!-- ìƒë‹¨ ë©”íŠ¸ë¦­ ì¹´ë“œ -->
    <div class="grid metrics">
      <div class="card metric"><div class="label">ì „ì²´ ì‹ ì²­</div><div class="value">{{ stats.total }}</div><div class="muted">ëˆ„ì  ê±´ìˆ˜</div></div>
      <div class="card metric"><div class="label">ì²˜ë¦¬ ì™„ë£Œ</div><div class="value">{{ stats.handled }}</div><div class="muted">ë‹µë³€ ê¸°ë¡</div></div>
      <div class="card metric"><div class="label">ëŒ€ê¸°</div><div class="value">{{ stats.pending }}</div><div class="muted">ë¯¸ì²˜ë¦¬</div></div>
      <div class="card metric"><div class="label">ì²˜ë¦¬ìœ¨</div><div class="value">{{ stats.handled_rate }}%</div><div class="bar"><span style="width: {{ stats.handled_rate }}%"></span></div></div>
      <div class="card metric"><div class="label">ì˜¤ëŠ˜</div><div class="value">{{ stats.today }}</div><div class="muted">ê¸ˆì¼ ì ‘ìˆ˜</div></div>
      <div class="card metric"><div class="label">ìµœê·¼ 7ì¼</div><div class="value">{{ stats.last7d }}</div><div class="muted">ì¼ì£¼ì¼ ëˆ„ì </div></div>
      <div class="card metric"><div class="label">ìµœê·¼ 30ì¼</div><div class="value">{{ stats.last30d }}</div><div class="muted">í•œ ë‹¬ ëˆ„ì </div></div>
      {% if stats.avg_response_hours %}<div class="card metric"><div class="label">í‰ê·  ì‘ë‹µ ì†Œìš”</div><div class="value">{{ stats.avg_response_hours }}h</div><div class="muted">ì‹ ì²­â†’ë‹µë³€</div></div>{% endif %}
    </div>

    <!-- ì¤‘ê°„ ë‘ ì¹¼ëŸ¼: ìƒìœ„ ì£¼ì œ / êµì‚¬ í™œë™ -->
    <div class="two-col section">
      <div class="card">
        <h2>ğŸ”¥ ìƒìœ„ ì£¼ì œ TOP 5</h2>
        <div class="list">
          {% for t, n in stats.top_topics %}
          <div class="row"><strong>{{ t }}</strong><span class="tag">{{ n }}ê±´</span></div>
          {% else %}<div class="muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>{% endfor %}
        </div>
      </div>

      <div class="card">
        <h2>ğŸ… ìµœê·¼ 30ì¼ êµì‚¬ í™œë™</h2>
        <div class="list">
          {% for name, cnt in stats.top_teachers_30d %}
          <div class="row"><strong>{{ name }}</strong><span class="pill">{{ cnt }}ê±´</span></div>
          {% else %}<div class="muted">ìµœê·¼ 30ì¼ í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>{% endfor %}
        </div>
      </div>
    </div>

    <!-- í•™ë…„/í•™ë°˜ ë¶„í¬ + ì‹ ì²­ì ìœ í˜• -->
    <div class="two-col section">
      <div class="card">
        <h2>ğŸ« í•™ë…„ë³„ ë¶„í¬</h2>
        {% set by_grade = stats.by_grade if stats.by_grade else grade_count %}
        {% set max_grade = (by_grade.values()|max) if by_grade else 1 %}
        <div class="list">
          {% for g, cnt in by_grade|dictsort %}
          <div class="row" style="gap:14px">
            <strong>{{ g }}í•™ë…„</strong>
            <div style="flex:1"><div class="bar"><span style="width: {{ (cnt/max_grade*100)|round(0) }}%"></span></div></div>
            <span class="tag">{{ cnt }}ê±´</span>
          </div>
          {% else %}<div class="muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>{% endfor %}
        </div>
      </div>

      <div class="card">
        <h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ì‹ ì²­ì ìœ í˜•</h2>
        <div class="list">
          <div class="row"><strong>í•™ìƒ</strong><span class="pill">{{ stats.applicant.student }}ê±´ ({{ stats.applicant.student_ratio }}%)</span></div>
          <div class="row"><strong>í•™ë¶€ëª¨</strong><span class="pill">{{ stats.applicant.parent }}ê±´ ({{ stats.applicant.parent_ratio }}%)</span></div>
        </div>
      </div>
    </div>

    <!-- ë¯¸ë‹µë³€ ìµœì‹  10ê±´ -->
    <div class="section card">
      <h2>â³ ë¯¸ë‹µë³€(ìµœì‹  10ê±´)</h2>
      {% if stats.recent_unanswered and stats.recent_unanswered|length > 0 %}
      <div style="overflow:auto">
        <table>
          <thead><tr><th>ì‹ ì²­ì¼</th><th>í•™ë…„/ë°˜</th><th>ë²ˆí˜¸</th><th class="left">ì´ë¦„</th><th class="left">ì£¼ì œ</th></tr></thead>
          <tbody>
            {% for r in stats.recent_unanswered %}
            <tr><td>{{ r.date }}</td><td>{{ r.grade }}-{{ r.class_num }}</td><td>{{ r.number }}</td><td class="left">{{ r.name }}</td><td class="left">{{ r.topic }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}<div class="muted">ë¯¸ë‹µë³€ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ‘</div>{% endif %}
    </div>

    <!-- ğŸ‘‡ ì¶”ê°€: ê·¸ë˜í”„ ì„¹ì…˜ (í”„ëŸ°íŠ¸ë§Œ) -->
    <div class="section two-col">
      <div class="card chart-box">
        <h2>ğŸ“ˆ TOP5 ì£¼ì œ (ê·¸ë˜í”„)</h2>
        <canvas id="chartTopics"></canvas>
        <div class="muted" id="noTopics" style="display:none">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
      <div class="card chart-box">
        <h2>ğŸ¯ ì‹ ì²­ì ìœ í˜• ë¹„ìœ¨</h2>
        <canvas id="chartApplicant"></canvas>
        <div class="muted" id="noApplicant" style="display:none">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </div>

    <div class="section card chart-box">
      <h2>ğŸ« í•™ë…„ë³„ ë¶„í¬ (ê·¸ë˜í”„)</h2>
      <canvas id="chartGrade"></canvas>
      <div class="muted" id="noGrade" style="display:none">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <div class="actions">
      <a class="btn" href="/teacher_home">ğŸ  êµì‚¬ í™ˆìœ¼ë¡œ</a>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      // ì„œë²„ ë°ì´í„° â†’ JS
      const topTopics = {{ stats.top_topics|tojson }};
      const applicant = {{ stats.applicant|tojson }};
      const gradeDist = {{ (stats.by_grade if stats.by_grade else grade_count)|tojson }};

      // ê³µí†µ íŒ”ë ˆíŠ¸
      const colors = ["#22a6b3","#6c5ce7","#7ed6df","#10b981","#f59e0b","#ef4444","#3b82f6"];

      // 1) TOP5 ì£¼ì œ ë§‰ëŒ€
      (function(){
        const el = document.getElementById('chartTopics');
        const empty = document.getElementById('noTopics');
        if(!topTopics || !topTopics.length){ el.style.display='none'; empty.style.display='block'; return; }
        const labels = topTopics.map(p=>p[0]);
        const data = topTopics.map(p=>p[1]);
        new Chart(el, {
          type:'bar',
          data:{ labels, datasets:[{ label:'ê±´ìˆ˜', data, backgroundColor:colors.slice(0,labels.length) }]},
          options:{
            responsive:true,
            plugins:{ legend:{ display:false }},
            scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }}}
          }
        });
      })();

      // 2) ì‹ ì²­ì ìœ í˜• ë„ë„›
      (function(){
        const el = document.getElementById('chartApplicant');
        const empty = document.getElementById('noApplicant');
        const student = applicant?.student || 0;
        const parent = applicant?.parent || 0;
        if(student+parent === 0){ el.style.display='none'; empty.style.display='block'; return; }
        new Chart(el, {
          type:'doughnut',
          data:{ labels:['í•™ìƒ','í•™ë¶€ëª¨'], datasets:[{ data:[student,parent], backgroundColor:[colors[0],colors[4]] }]},
          options:{ plugins:{ legend:{ position:'bottom' }}}
        });
      })();

      // 3) í•™ë…„ë³„ ë¶„í¬ ë§‰ëŒ€
      (function(){
        const el = document.getElementById('chartGrade');
        const empty = document.getElementById('noGrade');
        const keys = Object.keys(gradeDist||{}).sort((a,b)=>parseInt(a)-parseInt(b));
        if(!keys.length){ el.style.display='none'; empty.style.display='block'; return; }
        const data = keys.map(k=>gradeDist[k]);
        new Chart(el, {
          type:'bar',
          data:{ labels: keys.map(k=>k+'í•™ë…„'), datasets:[{ label:'ê±´ìˆ˜', data, backgroundColor:colors.slice(0,keys.length) }]},
          options:{
            responsive:true,
            plugins:{ legend:{ display:false }},
            scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }}}
          }
        });
      })();
    })();
  </script>
</body>
</html>
